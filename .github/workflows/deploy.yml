name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main  # Change to 'master' if that's your default branch
  workflow_dispatch:  # Allows manual triggering

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Inject API Configuration
        env:
          WEATHERAPI_KEY: ${{ secrets.WEATHERAPI_API_KEY }}
        run: |
          # Create config.js with obfuscated API key
          # Using base64 encoding for basic obfuscation (not true encryption, but hides from casual inspection)
          if [ -n "$WEATHERAPI_KEY" ]; then
            ENCODED_KEY=$(echo -n "$WEATHERAPI_KEY" | base64)
            cat > public/config.js << EOF
          // Auto-generated configuration - DO NOT EDIT MANUALLY
          (function() {
            window.APP_CONFIG = {
              weatherApiKey: '$ENCODED_KEY',
              apiVersion: '2.0'
            };
          })();
          EOF
            echo "✓ API configuration injected"
          else
            # Create empty config for testing without API key
            cat > public/config.js << EOF
          // Auto-generated configuration - DO NOT EDIT MANUALLY
          (function() {
            window.APP_CONFIG = {
              weatherApiKey: null,
              apiVersion: '2.0'
            };
          })();
          EOF
            echo "⚠ No API key found - creating empty config"
          fi
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './public'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
